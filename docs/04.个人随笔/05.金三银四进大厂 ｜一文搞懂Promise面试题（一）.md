---
title: é‡‘ä¸‰é“¶å››è¿›å¤§å‚ ï½œä¸€æ–‡ææ‡‚Promiseé¢è¯•é¢˜ï¼ˆä¸€ï¼‰
date: 2022-02-17 10:58:48
permalink: /pages/5fb6ca/
sidebar: auto
categories:
  - éšç¬”
tags:
  - 
---
# é‡‘ä¸‰é“¶å››è¿›å¤§å‚ ï½œä¸€æ–‡ææ‡‚ Promise é¢è¯•é¢˜ï¼ˆä¸€ï¼‰

---

## theme: awesome-green

æˆ‘æ­£åœ¨å‚ä¸[æ˜é‡‘åˆ›ä½œè€…è®­ç»ƒè¥ç¬¬ 4 æœŸ](https://juejin.cn/post/7064192649523101726 'https://juejin.cn/post/7064192649523101726')ï¼Œç‚¹å‡»äº†è§£æ´»åŠ¨è¯¦æƒ…ï¼Œä¸€èµ·å­¦ä¹ å§ï¼

## å‰è¨€

**ä½œè€…å¯„è¯­**

å¯¹äº Promiseï¼Œä½ æ˜¯ä¸æ˜¯è¿™æ ·çš„ï¼Ÿ

![image.png](https://img0.baidu.com/it/u=1970637895,3757735949&fm=253&fmt=auto&app=138&f=JPEG?w=340&h=271)

ä¹‹å‰å¯¹äº Promiseï¼Œå®ä»»åŠ¡ï¼Œå¾®ä»»åŠ¡è¿™äº›æ¦‚å¿µä¸€ç›´éƒ½æ˜¯æ··æ·†ä¸æ¸…ï¼Œæ¯æ¬¡é‡åˆ°ç±»ä¼¼çš„é¢è¯•é¢˜ï¼Œæˆ‘éƒ½æ˜¯é ç€ç›²çŒœï¼Œå°±ç®—çŒœå¯¹äº†ï¼Œé¢è¯•å®˜é—®æˆ‘ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Ÿä½ æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯å‡ºäºè¿™æ ·çš„ç°çŠ¶ï¼Œé‚£ä¹ˆå°±å¥½å¥½çœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼Œå¸¦ä½ å½»åº•ææ‡‚æ™¦æ¶©éš¾æ‡‚çš„ Promise é¢è¯•é¢˜ã€‚

æœ¬æ–‡çš„é¢˜ç›®æ²¡æœ‰åˆ°ç‰¹åˆ«æ·±å…¥ï¼Œä¸è¿‡åº”è¯¥è¦†ç›–äº†å¤§éƒ¨åˆ†çš„è€ƒç‚¹ï¼Œå¦å¤–ä¸ºäº†ä¸æŠŠå¤§å®¶ç»•æ··ï¼Œç­”æ¡ˆä¹Ÿæ²¡æœ‰è€ƒè™‘åœ¨ Node çš„æ‰§è¡Œç»“æœï¼Œæ‰§è¡Œç»“æœå…¨ä¸ºæµè§ˆå™¨ç¯å¢ƒä¸‹ã€‚å› æ­¤å¦‚æœä½ éƒ½ä¼šåšæˆ–è€…æœ‰ä»€ä¹ˆç–‘é—®çš„è¯ï¼Œå¯ä»¥å°½æƒ…çš„åœ¨è¯„è®ºåŒºç•™è¨€ï¼Œæˆ‘ä¼šä¸€ä¸€ç­”å¤çš„ã€‚

ğŸ“¢ ä¸€å…±åˆ†ä¸ºä¸Šä¸‹ä¸Šä¸‹ä¸¤ç¯‡æ–‡ç« ã€‚

**ğŸ’¡ è¿‡é˜…è¯»æœ¬ç¯‡æ–‡ç« ä½ å¯ä»¥å­¦åˆ°ï¼š**

- âœ… Promise çš„å‡ é“åŸºç¡€é¢˜
- âœ… Promise ç»“åˆ setTimeout
- âœ… Promise ä¸­çš„ thenã€catchã€finally

## å‰æœŸå‡†å¤‡

åœ¨åšä¸‹é¢ ğŸ‘‡ çš„é¢˜ç›®ä¹‹å‰ï¼Œæˆ‘å¸Œæœ›ä½ èƒ½æ¸…æ¥šå‡ ä¸ªçŸ¥è¯†ç‚¹ ğŸ’¡ğŸ’¡ğŸ’¡ã€‚

**event loop å®ƒçš„æ‰§è¡Œé¡ºåºï¼š**

- ğŸ“Œ ä¸€å¼€å§‹æ•´ä¸ªè„šæœ¬ä½œä¸ºä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œ
- ğŸ“Œ æ‰§è¡Œè¿‡ç¨‹ä¸­åŒæ­¥ä»£ç ç›´æ¥æ‰§è¡Œï¼Œå®ä»»åŠ¡è¿›å…¥å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¾®ä»»åŠ¡è¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
- ğŸ“Œ å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œå‡ºé˜Ÿï¼Œæ£€æŸ¥å¾®ä»»åŠ¡åˆ—è¡¨ï¼Œæœ‰åˆ™ä¾æ¬¡æ‰§è¡Œï¼Œç›´åˆ°å…¨éƒ¨æ‰§è¡Œå®Œ
- ğŸ“Œ æ‰§è¡Œæµè§ˆå™¨ UI çº¿ç¨‹çš„æ¸²æŸ“å·¥ä½œ
- ğŸ“Œ æ£€æŸ¥æ˜¯å¦æœ‰ Web Worker ä»»åŠ¡ï¼Œæœ‰åˆ™æ‰§è¡Œ
- ğŸ“Œ æ‰§è¡Œå®Œæœ¬è½®çš„å®ä»»åŠ¡ï¼Œå›åˆ° 2ï¼Œä¾æ­¤å¾ªç¯ï¼Œç›´åˆ°å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡é˜Ÿåˆ—éƒ½ä¸ºç©º

**å¾®ä»»åŠ¡åŒ…æ‹¬**ï¼šMutationObserverã€Promise.then()æˆ– reject()ã€Promise ä¸ºåŸºç¡€å¼€å‘çš„å…¶å®ƒæŠ€æœ¯ï¼Œæ¯”å¦‚ fetch APIã€V8 çš„åƒåœ¾å›æ”¶è¿‡ç¨‹ã€Node ç‹¬æœ‰çš„ process.nextTickã€‚

**å®ä»»åŠ¡åŒ…æ‹¬**ï¼šscript ã€setTimeout ã€setInterval ã€setImmediate ã€I/O ã€UI renderingã€‚

æ³¨æ„ ğŸš¸ï¼šåœ¨æ‰€æœ‰ä»»åŠ¡å¼€å§‹çš„æ—¶å€™ï¼Œç”±äºå®ä»»åŠ¡ä¸­åŒ…æ‹¬äº† scriptï¼Œæ‰€ä»¥æµè§ˆå™¨ä¼šå…ˆæ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä½ çœ‹åˆ°çš„å»¶è¿Ÿä»»åŠ¡(ä¾‹å¦‚ setTimeout)å°†è¢«æ”¾åˆ°ä¸‹ä¸€è½®å®ä»»åŠ¡ä¸­æ¥æ‰§è¡Œã€‚

ğŸ‘‡ ä¸‹é¢æˆ‘ä»¬ä»æ˜“åˆ°éš¾ï¼Œå¾ªåºæ¸è¿›ã€‚

> ğŸ“•**å¤‡æ³¨**ï¼šä¸‹é¢æ‰€æœ‰çš„é¢˜ç›®å¯ä»¥ç›´æ¥å¤åˆ¶åˆ°æµè§ˆå™¨æŸ¥çœ‹æ‰§è¡Œç»“æœï¼Œå»ºè®®å¤§å®¶å…ˆçœ‹é¢˜ç›®ï¼Œç„¶åå†æŸ¥çœ‹ç­”æ¡ˆï¼Œè¿™æ ·å°±æ˜ç™½è‡ªå·±çš„æ€è·¯æ˜¯å¯¹çš„è¿˜æ˜¯é”™çš„ï¼Œç„¶åå†çœ‹æˆ‘çš„è¿‡ç¨‹åˆ†æï¼Œå°±æŒæ¡çš„æ›´åŠ é€å½»ï¼Œè®°å¿†æ›´åŠ çš„æ·±åˆ»äº†ã€‚

## 1.åŸºç¡€é¢˜å‹

### é¢˜ 1-1

**é¢˜ç›®**ï¼š

```js
const promise1 = new Promise((resolve, reject) => {
  console.log('promise1');
});
console.log('1', promise1);
```

**è¿‡ç¨‹åˆ†æ**ï¼š

- ä»ä¸Šè‡³ä¸‹ï¼Œå…ˆé‡åˆ° new Promiseï¼Œæ‰§è¡Œè¯¥æ„é€ å‡½æ•°ä¸­çš„ä»£ç  promise1
- ç„¶åæ‰§è¡ŒåŒæ­¥ä»£ç  1ï¼Œæ­¤æ—¶ promise1 æ²¡æœ‰è¢« resolve æˆ–è€… rejectï¼Œå› æ­¤çŠ¶æ€è¿˜æ˜¯ pending

**æ‰§è¡Œç»“æœ**ï¼š

```
'promise1'
'1' Promise{<pending>}
```

### é¢˜ 1-2

**é¢˜ç›®**ï¼š

```js
const promise = new Promise((resolve, reject) => {
  console.log(1);
  resolve('success');
  console.log(2);
});
promise.then(() => {
  console.log(3);
});
console.log(4);
```

**è¿‡ç¨‹åˆ†æ**ï¼š

- ä»ä¸Šè‡³ä¸‹ï¼Œå…ˆé‡åˆ° new Promiseï¼Œæ‰§è¡Œå…¶ä¸­çš„åŒæ­¥ä»£ç  1
- å†é‡åˆ° resolve('success')ï¼Œ å°† promise çš„çŠ¶æ€æ”¹ä¸ºäº† resolved å¹¶ä¸”å°†å€¼ä¿å­˜ä¸‹æ¥
- ç»§ç»­æ‰§è¡ŒåŒæ­¥ä»£ç  2
- è·³å‡º promiseï¼Œå¾€ä¸‹æ‰§è¡Œï¼Œç¢°åˆ° promise.then è¿™ä¸ªå¾®ä»»åŠ¡ï¼Œå°†å…¶åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
- æ‰§è¡ŒåŒæ­¥ä»£ç  4
- æœ¬è½®å®ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œæ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå‘ç° promise.then è¿™ä¸ªå¾®ä»»åŠ¡ä¸”çŠ¶æ€ä¸º resolvedï¼Œæ‰§è¡Œå®ƒã€‚

**æ‰§è¡Œç»“æœ**ï¼š

```
1 2 4 3
```

### é¢˜ 1-3

**é¢˜ç›®**ï¼š

```js
const promise1 = new Promise((resolve, reject) => {
  console.log('promise1');
  resolve('resolve1');
});
const promise2 = promise1.then((res) => {
  console.log(res);
});
console.log('1', promise1);
console.log('2', promise2);
```

**è¿‡ç¨‹åˆ†æ**ï¼š

- ä»ä¸Šè‡³ä¸‹ï¼Œå…ˆé‡åˆ° new Promiseï¼Œæ‰§è¡Œè¯¥æ„é€ å‡½æ•°ä¸­çš„ä»£ç  promise1
- ç¢°åˆ° resolve å‡½æ•°, å°† promise1 çš„çŠ¶æ€æ”¹å˜ä¸º resolved, å¹¶å°†ç»“æœä¿å­˜ä¸‹æ¥
- ç¢°åˆ° promise1.then è¿™ä¸ªå¾®ä»»åŠ¡ï¼Œå°†å®ƒæ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
- promise2 æ˜¯ä¸€ä¸ªæ–°çš„çŠ¶æ€ä¸º pending çš„ Promise
- æ‰§è¡ŒåŒæ­¥ä»£ç  1ï¼Œ åŒæ—¶æ‰“å°å‡º promise1 çš„çŠ¶æ€æ˜¯ resolved
- æ‰§è¡ŒåŒæ­¥ä»£ç  2ï¼ŒåŒæ—¶æ‰“å°å‡º promise2 çš„çŠ¶æ€æ˜¯ pending
- å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼ŒæŸ¥æ‰¾å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå‘ç° promise1.then è¿™ä¸ªå¾®ä»»åŠ¡ä¸”çŠ¶æ€ä¸º resolvedï¼Œæ‰§è¡Œå®ƒ

**æ‰§è¡Œç»“æœ**ï¼š

```
'promise1'
'1' Promise{<resolved>: 'resolve1'}
'2' Promise{<pending>}
'resolve1'
```

å¥½å˜ï¼Œå­¦å®Œäº†è¿™å‡ é“åŸºç¡€é¢˜ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰è‡ªå·±åˆè¡Œäº†ï¼Ÿ

![image.png](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.jiuwa.net%2Fpic%2F20170821%2F1503323337847531.jpg&refer=http%3A%2F%2Fwww.jiuwa.net&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1647612333&t=44643142589cc44a139f25ebc8950ba5)

## 2.Promise ç»“åˆ setTimeout

### é¢˜ 2-1

**é¢˜ç›®**ï¼š

```js
console.log('start');
setTimeout(() => {
  console.log('time');
});
Promise.resolve().then(() => {
  console.log('resolve');
});
console.log('end');
```

**è¿‡ç¨‹åˆ†æ**ï¼š

- åˆšå¼€å§‹æ•´ä¸ªè„šæœ¬ä½œä¸ºä¸€ä¸ªå®ä»»åŠ¡æ¥æ‰§è¡Œï¼Œå¯¹äºåŒæ­¥ä»£ç ç›´æ¥å‹å…¥æ‰§è¡Œæ ˆè¿›è¡Œæ‰§è¡Œï¼Œå› æ­¤å…ˆæ‰“å°å‡º start å’Œ endã€‚
- setTimout ä½œä¸ºä¸€ä¸ªå®ä»»åŠ¡è¢«æ”¾å…¥å®ä»»åŠ¡é˜Ÿåˆ—(ä¸‹ä¸€ä¸ª)
- Promise.then ä½œä¸ºä¸€ä¸ªå¾®ä»»åŠ¡è¢«æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
- æœ¬æ¬¡å®ä»»åŠ¡æ‰§è¡Œå®Œï¼Œæ£€æŸ¥å¾®ä»»åŠ¡ï¼Œå‘ç° Promise.thenï¼Œæ‰§è¡Œå®ƒ
- æ¥ä¸‹æ¥è¿›å…¥ä¸‹ä¸€ä¸ªå®ä»»åŠ¡ï¼Œå‘ç° setTimeoutï¼Œæ‰§è¡Œã€‚

**æ‰§è¡Œç»“æœ**ï¼š

```
'start'
'end'
'resolve'
'time'
```

### é¢˜ 2-2

**é¢˜ç›®**ï¼š

```js
const promise = new Promise((resolve, reject) => {
  console.log(1);
  setTimeout(() => {
    console.log('timerStart');
    resolve('success');
    console.log('timerEnd');
  }, 0);
  console.log(2);
});
promise.then((res) => {
  console.log(res);
});
console.log(4);
```

**è¿‡ç¨‹åˆ†æ**ï¼š

- ä»ä¸Šè‡³ä¸‹ï¼Œå…ˆé‡åˆ° new Promiseï¼Œæ‰§è¡Œè¯¥æ„é€ å‡½æ•°ä¸­çš„ä»£ç  1
- ç„¶åç¢°åˆ°äº†å®šæ—¶å™¨ï¼Œå°†è¿™ä¸ªå®šæ—¶å™¨ä¸­çš„å‡½æ•°æ”¾åˆ°ä¸‹ä¸€ä¸ªå®ä»»åŠ¡çš„å»¶è¿Ÿé˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œ
- æ‰§è¡ŒåŒæ­¥ä»£ç  2
- è·³å‡º promise å‡½æ•°ï¼Œé‡åˆ° promise.thenï¼Œä½†å…¶çŠ¶æ€è¿˜æ˜¯ä¸º pendingï¼Œè¿™é‡Œç†è§£ä¸ºå…ˆä¸æ‰§è¡Œ
- æ‰§è¡ŒåŒæ­¥ä»£ç  4
- ä¸€è½®å¾ªç¯è¿‡åï¼Œè¿›å…¥ç¬¬äºŒæ¬¡å®ä»»åŠ¡ï¼Œå‘ç°å»¶è¿Ÿé˜Ÿåˆ—ä¸­æœ‰ setTimeout å®šæ—¶å™¨ï¼Œæ‰§è¡Œå®ƒ
- é¦–å…ˆæ‰§è¡Œ timerStartï¼Œç„¶åé‡åˆ°äº† resolveï¼Œå°† promise çš„çŠ¶æ€æ”¹ä¸º resolved ä¸”ä¿å­˜ç»“æœå¹¶å°†ä¹‹å‰çš„ promise.then æ¨å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
- ç»§ç»­æ‰§è¡ŒåŒæ­¥ä»£ç  timerEnd
- å®ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼ŒæŸ¥æ‰¾å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå‘ç° promise.then è¿™ä¸ªå¾®ä»»åŠ¡ï¼Œæ‰§è¡Œå®ƒã€‚

**æ‰§è¡Œç»“æœ**ï¼š

```
1
2
4
"timerStart"
"timerEnd"
"success"
```

### é¢˜ 2-3

**é¢˜ç›®**ï¼š

```js
Promise.resolve().then(() => {
  console.log('promise1');
  const timer2 = setTimeout(() => {
    console.log('timer2');
  }, 0);
});
const timer1 = setTimeout(() => {
  console.log('timer1');
  Promise.resolve().then(() => {
    console.log('promise2');
  });
}, 0);
console.log('start');
```

**è¿‡ç¨‹åˆ†æ**ï¼š

è¿™é“é¢˜ç¨å¾®çš„éš¾ä¸€äº›ï¼Œåœ¨ promise ä¸­æ‰§è¡Œå®šæ—¶å™¨ï¼Œåˆåœ¨å®šæ—¶å™¨ä¸­æ‰§è¡Œ promiseï¼›

å¹¶ä¸”è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ Promise æ˜¯ç›´æ¥ resolve çš„ï¼Œè€Œä¹‹å‰çš„ new Promise ä¸ä¸€æ ·ã€‚

å› æ­¤æ‰§è¡Œè¿‡ç¨‹ä¸ºï¼š

- åˆšå¼€å§‹æ•´ä¸ªè„šæœ¬ä½œä¸ºç¬¬ä¸€æ¬¡å®ä»»åŠ¡æ¥æ‰§è¡Œï¼Œæˆ‘ä»¬å°†å®ƒæ ‡è®°ä¸ºå® 1ï¼Œä»ä¸Šè‡³ä¸‹æ‰§è¡Œ
- é‡åˆ° Promise.resolve().then è¿™ä¸ªå¾®ä»»åŠ¡ï¼Œå°† then ä¸­çš„å†…å®¹åŠ å…¥ç¬¬ä¸€æ¬¡çš„å¾®ä»»åŠ¡é˜Ÿåˆ—æ ‡è®°ä¸ºå¾® 1
- é‡åˆ°å®šæ—¶å™¨ timer1ï¼Œå°†å®ƒåŠ å…¥ä¸‹ä¸€æ¬¡å®ä»»åŠ¡çš„å»¶è¿Ÿåˆ—è¡¨ï¼Œæ ‡è®°ä¸ºå® 2ï¼Œç­‰å¾…æ‰§è¡Œ(å…ˆä¸ç®¡é‡Œé¢æ˜¯ä»€ä¹ˆå†…å®¹)
- æ‰§è¡Œå® 1 ä¸­çš„åŒæ­¥ä»£ç  start
- ç¬¬ä¸€æ¬¡å®ä»»åŠ¡(å® 1)æ‰§è¡Œå®Œæ¯•ï¼Œæ£€æŸ¥ç¬¬ä¸€æ¬¡çš„å¾®ä»»åŠ¡é˜Ÿåˆ—(å¾® 1)ï¼Œå‘ç°æœ‰ä¸€ä¸ª promise.then è¿™ä¸ªå¾®ä»»åŠ¡éœ€è¦æ‰§è¡Œ
- æ‰§è¡Œæ‰“å°å‡ºå¾® 1 ä¸­åŒæ­¥ä»£ç  promise1ï¼Œç„¶åå‘ç°å®šæ—¶å™¨ timer2ï¼Œå°†å®ƒåŠ å…¥å® 2 çš„åé¢ï¼Œæ ‡è®°ä¸ºå® 3
- ç¬¬ä¸€æ¬¡å¾®ä»»åŠ¡é˜Ÿåˆ—(å¾® 1)æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œç¬¬äºŒæ¬¡å®ä»»åŠ¡(å® 2)ï¼Œé¦–å…ˆæ‰§è¡ŒåŒæ­¥ä»£ç  timer1
- ç„¶åé‡åˆ°äº† promise2 è¿™ä¸ªå¾®ä»»åŠ¡ï¼Œå°†å®ƒåŠ å…¥æ­¤æ¬¡å¾ªç¯çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ ‡è®°ä¸ºå¾® 2
- å® 2 ä¸­æ²¡æœ‰åŒæ­¥ä»£ç å¯æ‰§è¡Œäº†ï¼ŒæŸ¥æ‰¾æœ¬æ¬¡å¾ªç¯çš„å¾®ä»»åŠ¡é˜Ÿåˆ—(å¾® 2)ï¼Œå‘ç°äº† promise2ï¼Œæ‰§è¡Œå®ƒ
- ç¬¬äºŒè½®æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œå® 3ï¼Œæ‰“å°å‡º timer2

**æ‰§è¡Œç»“æœ**ï¼š

```
'start'
'promise1'
'timer1'
'promise2'
'timer2'
```

## 3.Promise ä¸­çš„ thenã€catchã€finally

### é¢˜ 3-1

**é¢˜ç›®**ï¼š

```js
const promise = new Promise((resolve, reject) => {
  resolve('success1');
  reject('error');
  resolve('success2');
});
promise
  .then((res) => {
    console.log('then: ', res);
  })
  .catch((err) => {
    console.log('catch: ', err);
  });
```

**è¿‡ç¨‹åˆ†æ**ï¼š

æ„é€ å‡½æ•°ä¸­çš„ resolve æˆ– reject åªæœ‰ç¬¬ä¸€æ¬¡æ‰§è¡Œæœ‰æ•ˆï¼Œå¤šæ¬¡è°ƒç”¨æ²¡æœ‰ä»»ä½•ä½œç”¨ ã€‚å¾—å‡ºç»“è®ºï¼šPromise çš„çŠ¶æ€ä¸€ç»æ”¹å˜å°±ä¸èƒ½å†æ”¹å˜ã€‚

**æ‰§è¡Œç»“æœ**ï¼š

```
"then: success1"
```

### é¢˜ 3-2

**é¢˜ç›®**ï¼š

```js
const promise = newPromise((resolve, reject) => {
  reject('error');
  resolve('success2');
});
promise
  .then((res) => {
    console.log('then: ', res);
  })
  .then((res) => {
    console.log('then: ', res);
  })
  .catch((err) => {
    console.log('catch: ', err);
  })
  .then((res) => {
    console.log('then: ', res);
  });
```

**æ‰§è¡Œç»“æœ**ï¼š

```
"catch: " "error"
"then3: " undefined
```

**ç»“è®º**

catch ä¸ç®¡è¢«è¿æ¥åˆ°å“ªé‡Œï¼Œéƒ½èƒ½æ•è·ä¸Šå±‚çš„é”™è¯¯ã€‚

### é¢˜ 3-3

**é¢˜ç›®**ï¼š

```js
Promise.resolve(1)
  .then((res) => {
    console.log(res);
    return2;
  })
  .catch((err) => {
    return3;
  })
  .then((res) => {
    console.log(res);
  });
```

**è¿‡ç¨‹åˆ†æ**ï¼š

Promise å¯ä»¥é“¾å¼è°ƒç”¨ï¼Œä¸è¿‡ promise æ¯æ¬¡è°ƒç”¨ .then æˆ–è€… .catch éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ promiseï¼Œä»è€Œå®ç°äº†é“¾å¼è°ƒç”¨, å®ƒå¹¶ä¸åƒä¸€èˆ¬æˆ‘ä»¬ä»»åŠ¡çš„é“¾å¼è°ƒç”¨ä¸€æ · return thisã€‚

ä¸Šé¢çš„è¾“å‡ºç»“æœä¹‹æ‰€ä»¥ä¾æ¬¡æ‰“å°å‡º 1 å’Œ 2ï¼Œé‚£æ˜¯å› ä¸º resolve(1)ä¹‹åèµ°çš„æ˜¯ç¬¬ä¸€ä¸ª then æ–¹æ³•ï¼Œå¹¶æ²¡æœ‰èµ° catch é‡Œï¼Œæ‰€ä»¥ç¬¬äºŒä¸ª then ä¸­çš„ res å¾—åˆ°çš„å®é™…ä¸Šæ˜¯ç¬¬ä¸€ä¸ª then çš„è¿”å›å€¼ã€‚ä¸” return 2 ä¼šè¢«åŒ…è£…æˆ resolve(2)ã€‚

**æ‰§è¡Œç»“æœ**ï¼š

```
1
2
```

### é¢˜ 3-4

**é¢˜ç›®**ï¼š

```js
Promise.resolve()
  .then(() => {
    returnnewError('error!!!');
  })
  .then((res) => {
    console.log('then: ', res);
  })
  .catch((err) => {
    console.log('catch: ', err);
  });
```

**è¿‡ç¨‹åˆ†æ**ï¼š

çŒœçŒœè¿™é‡Œçš„ç»“æœè¾“å‡ºçš„æ˜¯ä»€ä¹ˆ ğŸ¤”ï¸ ï¼Ÿ

ä½ å¯èƒ½æƒ³åˆ°çš„æ˜¯è¿›å…¥.catch ç„¶åè¢«æ•è·äº†é”™è¯¯ã€‚

ç»“æœå¹¶ä¸æ˜¯è¿™æ ·çš„ï¼Œå®ƒèµ°çš„æ˜¯.then é‡Œé¢ï¼Œè¿”å›ä»»æ„ä¸€ä¸ªé promise çš„å€¼éƒ½ä¼šè¢«åŒ…è£¹æˆ promise å¯¹è±¡ï¼Œå› æ­¤è¿™é‡Œçš„ return new Error('error!!!')ä¹Ÿè¢«åŒ…è£¹æˆäº† return Promise.resolve(new Error('error!!!'))ã€‚

å½“ç„¶å¦‚æœä½ æŠ›å‡ºä¸€ä¸ªé”™è¯¯çš„è¯ï¼Œå¯ä»¥ç”¨ä¸‹é¢ ğŸ‘‡ ä¸¤çš„ä»»æ„ä¸€ç§ï¼š

```js
returnPromise.reject(newError('error!!!'));
// or
thrownewError('error!!!');
```

**æ‰§è¡Œç»“æœ**ï¼š

```
"then: " "Error: error!!!"
```

### é¢˜ 3-5

**é¢˜ç›®**ï¼š

æ¥ä¸‹æ¥ä»‹ç»ä¸€ä¸‹.then å‡½æ•°ä¸­çš„ä¸¤ä¸ªå‚æ•°ã€‚

ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨æ¥å¤„ç† Promise æˆåŠŸçš„å‡½æ•°ï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯å¤„ç†å¤±è´¥çš„å‡½æ•°ã€‚

ä¹Ÿå°±æ˜¯è¯´ Promise.resolve('1')çš„å€¼ä¼šè¿›å…¥æˆåŠŸçš„å‡½æ•°ï¼ŒPromise.reject('2')çš„å€¼ä¼šè¿›å…¥å¤±è´¥çš„å‡½æ•°ã€‚

è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªä¾‹å­ ğŸŒ°ï¼š

```js
Promise.reject('err!!!')
  .then(
    (res) => {
      console.log('success', res);
    },
    (err) => {
      console.log('error', err);
    }
  )
  .catch((err) => {
    console.log('catch', err);
  });
```

**æ‰§è¡Œç»“æœ**ï¼š

```
'error' 'error!!!'
```

å®ƒè¿›å…¥çš„æ˜¯ then()ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°é‡Œé¢ï¼Œè€Œå¦‚æœæŠŠç¬¬äºŒä¸ªå‚æ•°å»æ‰ï¼Œå°±è¿›å…¥äº† catch()ä¸­ï¼š

```js
Promise.reject('err!!!')
  .then((res) => {
    console.log('success', res);
  })
  .catch((err) => {
    console.log('catch', err);
  });
```

**æ‰§è¡Œç»“æœ**ï¼š

```
'catch' 'error!!!'
```

### é¢˜ 3-6

æ¥ç€æ¥çœ‹çœ‹.finally()ï¼Œè¿™ä¸ªåŠŸèƒ½ä¸€èˆ¬ä¸å¤ªç”¨åœ¨é¢è¯•ä¸­ï¼Œä¸è¿‡å¦‚æœç¢°åˆ°äº†ä½ ä¹Ÿåº”è¯¥çŸ¥é“è¯¥å¦‚ä½•å¤„ç†ã€‚

å…¶å®ä½ åªè¦è®°ä½å®ƒä¸‰ä¸ªå¾ˆé‡è¦çš„çŸ¥è¯†ç‚¹å°±å¯ä»¥äº†ï¼š

- .finally()æ–¹æ³•ä¸ç®¡ Promise å¯¹è±¡æœ€åçš„çŠ¶æ€å¦‚ä½•éƒ½ä¼šæ‰§è¡Œ
- .finally()æ–¹æ³•çš„å›è°ƒå‡½æ•°ä¸æ¥å—ä»»ä½•çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ åœ¨.finally()å‡½æ•°ä¸­æ˜¯æ²¡æ³•çŸ¥é“ Promise æœ€ç»ˆçš„çŠ¶æ€æ˜¯ resolved è¿˜æ˜¯ rejected çš„
- å®ƒæœ€ç»ˆè¿”å›çš„é»˜è®¤ä¼šæ˜¯ä¸€ä¸ªåŸæ¥çš„ Promise å¯¹è±¡å€¼ï¼Œä¸è¿‡å¦‚æœæŠ›å‡ºçš„æ˜¯ä¸€ä¸ªå¼‚å¸¸åˆ™è¿”å›å¼‚å¸¸çš„ Promise å¯¹è±¡ã€‚

æ¥çœ‹çœ‹è¿™ä¸ªç®€å•çš„ä¾‹å­ ğŸŒ°ï¼š

**é¢˜ç›®**ï¼š

```js
Promise.resolve('1')
  .then((res) => {
    console.log(res);
  })
  .finally(() => {
    console.log('finally');
  });
Promise.resolve('2')
  .finally(() => {
    console.log('finally2');
    return 'æˆ‘æ˜¯finally2è¿”å›çš„å€¼';
  })
  .then((res) => {
    console.log('finally2åé¢çš„thenå‡½æ•°', res);
  });
```

**è¿‡ç¨‹åˆ†æ**ï¼š
è¿™ä¸¤ä¸ª Promise çš„.finally éƒ½ä¼šæ‰§è¡Œï¼Œä¸”å°±ç®— finally2 è¿”å›äº†æ–°çš„å€¼ï¼Œå®ƒåé¢çš„ then()å‡½æ•°æ¥æ”¶åˆ°çš„ç»“æœå´è¿˜æ˜¯'2'ï¼Œå› æ­¤æ‰“å°ç»“æœä¸ºï¼š

**æ‰§è¡Œç»“æœ**ï¼š

```
'1'
'finally2'
'finally'
'finally2åé¢çš„thenå‡½æ•°' '2'
```

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ¯”è¾ƒéš¾çš„ä¾‹å­ ğŸŒ°ï¼š

```js
function promise1 () {
  let p = new Promise((resolve) => {
    console.log('promise1');
    resolve('1')
  })
  return p;
}
function promise2 () {
  retur nnew Promise((resolve, reject) => {
    reject('error')
  })
}
promise1()
  .then(res =>console.log(res))
  .catch(err =>console.log(err))
  .finally(() =>console.log('finally1'))

promise2()
  .then(res =>console.log(res))
  .catch(err =>console.log(err))
  .finally(() =>console.log('finally2'))
```

**è¿‡ç¨‹åˆ†æ**ï¼š

- é¦–å…ˆå®šä¹‰äº†ä¸¤ä¸ªå‡½æ•° promise1 å’Œ promise2ï¼Œå…ˆä¸ç®¡æ¥ç€å¾€ä¸‹çœ‹ã€‚
- promise1 å‡½æ•°å…ˆè¢«è°ƒç”¨äº†ï¼Œç„¶åæ‰§è¡Œé‡Œé¢ new Promise çš„åŒæ­¥ä»£ç æ‰“å°å‡º promise1
- ä¹‹åé‡åˆ°äº† resolve(1)ï¼Œå°† p çš„çŠ¶æ€æ”¹ä¸ºäº† resolved å¹¶å°†ç»“æœä¿å­˜ä¸‹æ¥ã€‚
- æ­¤æ—¶ promise1 å†…çš„å‡½æ•°å†…å®¹å·²ç»æ‰§è¡Œå®Œäº†ï¼Œè·³å‡ºè¯¥å‡½æ•°
- ç¢°åˆ°äº† promise1().then()ï¼Œç”±äº promise1 çš„çŠ¶æ€å·²ç»å‘ç”Ÿäº†æ”¹å˜ä¸”ä¸º resolved å› æ­¤å°† promise1().then()è¿™æ¡å¾®ä»»åŠ¡åŠ å…¥æœ¬è½®çš„å¾®ä»»åŠ¡åˆ—è¡¨(è¿™æ˜¯ç¬¬ä¸€ä¸ªå¾®ä»»åŠ¡)
- è¿™æ—¶å€™è¦æ³¨æ„äº†ï¼Œä»£ç å¹¶ä¸ä¼šæ¥ç€å¾€é“¾å¼è°ƒç”¨çš„ä¸‹é¢èµ°ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šå…ˆå°†.finally åŠ å…¥å¾®ä»»åŠ¡åˆ—è¡¨ï¼Œé‚£æ˜¯å› ä¸º.then æœ¬èº«å°±æ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œå®ƒé“¾å¼åé¢çš„å†…å®¹å¿…é¡»å¾—ç­‰å½“å‰è¿™ä¸ªå¾®ä»»åŠ¡æ‰§è¡Œå®Œæ‰ä¼šæ‰§è¡Œï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬å…ˆä¸ç®¡.finally()
- å†å¾€ä¸‹èµ°ç¢°åˆ°äº† promise2()å‡½æ•°ï¼Œå…¶ä¸­è¿”å›çš„ new Promise ä¸­å¹¶æ²¡æœ‰åŒæ­¥ä»£ç éœ€è¦æ‰§è¡Œï¼Œæ‰€ä»¥æ‰§è¡Œ reject('error')çš„æ—¶å€™å°† promise2 å‡½æ•°ä¸­çš„ Promise çš„çŠ¶æ€å˜ä¸ºäº† rejected
- è·³å‡º promise2 å‡½æ•°ï¼Œé‡åˆ°äº† promise2().then()ï¼Œå°†å…¶åŠ å…¥å½“å‰çš„å¾®ä»»åŠ¡é˜Ÿåˆ—(è¿™æ˜¯ç¬¬äºŒä¸ªå¾®ä»»åŠ¡)ï¼Œä¸”é“¾å¼è°ƒç”¨åé¢çš„å†…å®¹å¾—ç­‰è¯¥ä»»åŠ¡æ‰§è¡Œå®Œåæ‰æ‰§è¡Œï¼Œå’Œ.then()ä¸€æ ·ã€‚
- OKï¼Œ æœ¬è½®çš„å®ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œäº†ï¼Œæ¥çœ‹çœ‹å¾®ä»»åŠ¡åˆ—è¡¨ï¼Œå­˜åœ¨ promise1().then()ï¼Œæ‰§è¡Œå®ƒï¼Œæ‰“å°å‡º 1ï¼Œç„¶åé‡åˆ°äº†.finally()è¿™ä¸ªå¾®ä»»åŠ¡å°†å®ƒåŠ å…¥å¾®ä»»åŠ¡åˆ—è¡¨(è¿™æ˜¯ç¬¬ä¸‰ä¸ªå¾®ä»»åŠ¡)ç­‰å¾…æ‰§è¡Œ
- å†æ‰§è¡Œ promise2().catch()æ‰“å°å‡º errorï¼Œæ‰§è¡Œå®Œåå°† finally2 åŠ å…¥å¾®ä»»åŠ¡åŠ å…¥å¾®ä»»åŠ¡åˆ—è¡¨(è¿™æ˜¯ç¬¬å››ä¸ªå¾®ä»»åŠ¡)
- OKï¼Œ æœ¬è½®åˆå…¨éƒ¨æ‰§è¡Œå®Œäº†ï¼Œä½†æ˜¯å¾®ä»»åŠ¡åˆ—è¡¨è¿˜æœ‰ä¸¤ä¸ªæ–°çš„å¾®ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œå®Œï¼Œå› æ­¤ä¾æ¬¡æ‰§è¡Œ finally1 å’Œ finally2ã€‚

**æ‰§è¡Œç»“æœ**ï¼š

```
'promise1'
'1'
'error'
'finally1'
'finally2'
```

ä¸€å£æ°”çœ‹äº†è¿™ä¹ˆå¤šé¢˜ï¼Œè®©æˆ‘ä»¬å–ä¸€å£ ğŸµï¼Œç„¶åæ€»ç»“ä¸€ä¸‹ï¼š

> ğŸ“—**æ€»ç»“ç»“è®º**ï¼š
>
> - ğŸ“ Promise çš„çŠ¶æ€ä¸€ç»æ”¹å˜å°±ä¸èƒ½å†æ”¹å˜.
> - ğŸ“ .then å’Œ.catch éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise.
> - ğŸ“ catch ä¸ç®¡è¢«è¿æ¥åˆ°å“ªé‡Œï¼Œéƒ½èƒ½æ•è·ä¸Šå±‚çš„é”™è¯¯ã€‚ -åœ¨ Promise ä¸­ï¼Œè¿”å›ä»»æ„ä¸€ä¸ªé promise çš„å€¼éƒ½ä¼šè¢«åŒ…è£¹æˆ promise å¯¹è±¡ï¼Œä¾‹å¦‚ return 2 ä¼šè¢«åŒ…è£…ä¸º return Promise.resolve(2)ã€‚
> - ğŸ“ Promise çš„ .then æˆ–è€… .catch å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡, å½“å¦‚æœ Promise å†…éƒ¨çš„çŠ¶æ€ä¸€ç»æ”¹å˜ï¼Œå¹¶ä¸”æœ‰äº†ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆåç»­æ¯æ¬¡è°ƒç”¨.then æˆ–è€….catch çš„æ—¶å€™éƒ½ä¼šç›´æ¥æ‹¿åˆ°è¯¥å€¼ã€‚
> - ğŸ“ .then æˆ–è€… .catch ä¸­ return ä¸€ä¸ª error å¯¹è±¡å¹¶ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œæ‰€ä»¥ä¸ä¼šè¢«åç»­çš„ .catch æ•è·ã€‚
> - ğŸ“ .then æˆ– .catch è¿”å›çš„å€¼ä¸èƒ½æ˜¯ promise æœ¬èº«ï¼Œå¦åˆ™ä¼šé€ æˆæ­»å¾ªç¯ã€‚
> - ğŸ“ .then æˆ–è€… .catch çš„å‚æ•°æœŸæœ›æ˜¯å‡½æ•°ï¼Œä¼ å…¥éå‡½æ•°åˆ™ä¼šå‘ç”Ÿå€¼ç©¿é€ã€‚
> - ğŸ“ .then æ–¹æ³•æ˜¯èƒ½æ¥æ”¶ä¸¤ä¸ªå‚æ•°çš„ï¼Œç¬¬ä¸€ä¸ªæ˜¯å¤„ç†æˆåŠŸçš„å‡½æ•°ï¼Œç¬¬äºŒä¸ªæ˜¯å¤„ç†å¤±è´¥çš„å‡½æ•°ï¼Œå†æŸäº›æ—¶å€™ä½ å¯ä»¥è®¤ä¸º catch æ˜¯.then ç¬¬äºŒä¸ªå‚æ•°çš„ç®€ä¾¿å†™æ³•ã€‚
> - ğŸ“ .finally æ–¹æ³•ä¹Ÿæ˜¯è¿”å›ä¸€ä¸ª Promiseï¼Œä»–åœ¨ Promise ç»“æŸçš„æ—¶å€™ï¼Œæ— è®ºç»“æœä¸º resolved è¿˜æ˜¯ rejectedï¼Œéƒ½ä¼šæ‰§è¡Œé‡Œé¢çš„å›è°ƒå‡½æ•°ã€‚

â³**ä¸‹æœŸæ–‡ç« é¢„å‘Šï¼š**

- Promise ä¸­çš„ all å’Œ race
- async/await çš„å‡ é“é¢˜
- å¤§å‚é¢è¯•é¢˜

## å†™åœ¨æœ€å

> æœ½æœ¨ä¸é›•éš¾æˆæ‰ï¼ŒçŸ¥è€»åå‹‡å‡Œäº‘å¿—ã€‚
> æˆ‘æ˜¯**æœ½æœ¨ç™½**ï¼Œä¸€ä¸ªçƒ­çˆ±åˆ†äº«çš„ç¨‹åºçŒ¿ã€‚å¦‚æœè§‰å¾—æœ¬æ–‡è¿˜ä¸é”™ï¼Œè®°å¾—**ç‚¹èµ â• å…³æ³¨**ï¼Œè¯´ä¸å®šå“ªå¤©å°±ç”¨å¾—ä¸Šï¼æ‚¨çš„é¼“åŠ±æ˜¯æˆ‘åšæŒä¸‹å»çš„æœ€å¤§åŠ¨åŠ› â¤ï¸â¤ï¸â¤ï¸ã€‚
